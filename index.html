<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Futures Assets Mockup (Mobile Size + Profits)</title>

  <!-- Fonts & Icons -->
  <link href="https://db.onlinewebfonts.com/c/d05c19ccecf7003d248c60ffd6b5e8f7?family=Binance+PLEX" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <style>
    :root{
      --app-w: 375px;
      --bg-base:#1E2128;
      --panel-bg:#1e2127;
      --secondary-bg:#32383e;
      --text-secondary:#7c828a;
      --text-green:#3acf87;
      --text-red:#e04b4a;
      --btn-bg:#2f3339;
      --highlight:#f0b90b;

      /* tiny segmented control sizing */
      --seg-w: 170px;
      --seg-h: 24px;
      --seg-pad: 2px;
      --seg-gap: 2px;
      --seg-r: 10px;
      --seg-thumb-r: 6px;
      --seg-font: 12px;
    }

    *{margin:0;padding:0;box-sizing:border-box}
    body{
      background:var(--bg-base);
      display:flex;justify-content:center;align-items:flex-start;
      padding:20px;min-height:100vh;color:#E1E3E8
    }
    .app{
      width:var(--app-w);max-width:100%;
      background:var(--bg-base);color:#E1E3E8;
      border:1px solid #333;border-radius:16px;overflow:hidden;position:relative;
      padding:12px 16px 80px;font-family:"Segoe UI",Roboto,sans-serif
    }
    .amount,.value,.rate{font-family:"Binance PLEX",sans-serif!important}
    button{cursor:pointer;border:none;background:transparent;font:inherit;color:inherit}

    /* ===== Exchange / Wallet segmented control (much smaller) ===== */
    .top-toggle{
      position:relative;
      width:var(--seg-w);
      margin:2px auto 6px;
      padding:var(--seg-pad);
      background:#20242c;
      border:1px solid #343a40;
      border-radius:var(--seg-r);
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:var(--seg-gap);
    }
    .top-toggle .seg-thumb{
      position:absolute;
      top:var(--seg-pad);
      bottom:var(--seg-pad);
      left:var(--seg-pad);
      width:calc(50% - var(--seg-gap));
      background:#2b303a;
      border:1px solid #3f4652;
      border-radius:var(--seg-thumb-r);
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.02),
        0 2px 8px rgba(0,0,0,.35);
      transition:transform .25s ease;
      transform:translateX(0%);
    }
    .top-toggle .toggle-btn{
      position:relative;
      z-index:1;
      height:var(--seg-h);
      line-height:var(--seg-h);
      padding:0 8px;
      font-size:var(--seg-font);
      font-weight:700;
      color:#9ba3af;
      border-radius:var(--seg-thumb-r);
      letter-spacing:.2px;
    }
    .top-toggle .toggle-btn.active{ color:#fff; }

    /* ===== Upper navs ===== */
    .main-nav{display:flex;justify-content:flex-start;gap:10px;margin:2px 0 6px 0}
    .main-nav button{padding:8px 6px;font-size:13px;color:#A1A6B0}
    .main-nav button.active{color:#FFF;border-bottom:2px solid #FFF}

    .sub-toggle{display:flex;gap:6px;margin:8px 0}
    .sub-toggle .toggle-btn{padding:4px 8px;font-size:11px;color:#A1A6B0;border-radius:6px;background:transparent}
    .sub-toggle .toggle-btn.active{background:#323742;color:#FFF}

    .balance-panel{margin:12px 0}
    .balance-header{display:flex;justify-content:space-between;align-items:center;color:#A1A6B0;font-size:12px}
    .balance-header span{display:flex;align-items:center;gap:6px}
    .balance-header i{cursor:pointer;font-size:12px}
    .icon-group{display:inline-flex;gap:10px;font-size:13px;color:#E1E3E8}
    .balance-amount{display:flex;align-items:flex-end;margin:8px 0}
    .amount{font-size:28px;font-weight:600}
    .currency{margin-left:8px;color:#A1A6B0;font-size:12px}
    .realized-pnl{color:#A1A6B0;font-size:12px}
    .realized-pnl .gain{color:var(--text-green);font-weight:700}

    .small-balances{display:flex;margin-top:12px;justify-content:space-between}
    .small-item{display:flex;flex-direction:column}
    .small-item .label{color:#A1A6B0;font-size:12px}
    .small-item .value{font-size:14px;font-weight:600;margin-top:4px}

    .actions{display:flex;margin:14px 0}
    .btn{flex:1;padding:8px 0;font-size:13px;margin:0 4px;border-radius:6px;background:#323742;color:#A1A6B0}
    .btn.primary,.btn.active{background:#F3BA2F;color:#1E2128}

    .sub-nav-2{display:flex;align-items:flex-end;gap:16px;margin:0 0 8px 0}
    .sub-nav-2 button{position:relative;padding:0 6px 8px;font-size:14px;font-weight:700;letter-spacing:.1px;color:var(--text-secondary);line-height:1;font-family:"Binance PLEX","Segoe UI",Roboto,sans-serif}
    .sub-nav-2 button.active{color:#fff}
    .sub-nav-2 button.active::after{
      content:"";position:absolute;bottom:0;left:50%;transform:translateX(-50%);
      width:26px;height:3px;background:var(--highlight);border-radius:2px
    }

    .feed{display:flex;flex-direction:column;gap:8px;width:100%;max-height:calc(100vh - 300px);overflow-y:auto;padding:12px 0 20px;background:var(--bg-base)}
    .feed::-webkit-scrollbar{display:none}
    .empty-state{margin:0;background:var(--panel-bg);border-radius:10px;padding:20px;text-align:center;border:1px solid #2b2f36}
    .empty-state i{font-size:28px;opacity:.9;margin-bottom:10px;display:inline-block}
    .empty-state h4{font-size:14px;margin-bottom:6px}
    .empty-state p{font-size:12px;color:#A1A6B0;margin-bottom:12px}
    .empty-state .cta{background:#F3BA2F;color:#1E2128;font-size:12px;padding:8px 12px;border-radius:6px;display:inline-flex;align-items:center;gap:6px}

    .trade-panel{background:transparent;border:none;border-radius:10px;padding:12px 0;margin:12px 0;transition:transform .5s ease}
    .trade-panel .header{display:flex;align-items:center;margin-bottom:8px}
    .trade-panel .icon-buy{background:var(--text-green);color:#fff;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;margin-right:8px;border-radius:2px}
    .trade-panel .symbol{font-size:14px;font-weight:600;margin-right:6px;color:#fff}
    .trade-panel .tag{background:var(--secondary-bg);color:var(--text-secondary);font-size:10px;padding:1px 4px;margin-right:4px;text-transform:uppercase;border-radius:3px}
    .trade-panel .exclamations{display:flex;margin-left:6px}
    .trade-panel .exclamations span{position:relative;width:2px;height:10px;background:var(--secondary-bg);margin:0 1px;border-radius:1px;transition:background .3s ease}
    .trade-panel .exclamations span::after{content:'';position:absolute;bottom:-3px;left:50%;transform:translateX(-50%);width:2px;height:2px;background:inherit;border-radius:50%}
    .trade-panel .exclamations span.green,.trade-panel .exclamations span.green::after{background:var(--text-green)}
    .trade-panel .share{margin-left:auto;color:#var(--text-secondary);font-size:16px;cursor:pointer}

    .trade-panel .content-columns{display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:8px;gap:8px}
    .trade-panel .column{display:flex;flex-direction:column}
    .trade-panel .column.right{text-align:right}
    .trade-panel .stat{margin-bottom:8px}
    .trade-panel .label{font-size:12px;color:var(--text-secondary);border-bottom:1px dotted var(--text-secondary);padding-bottom:2px;display:inline-block}
    .trade-panel .label.no-line{border-bottom:none}
    .trade-panel .value{font-size:14px;font-weight:400;color:#fff;transition:all .3s ease}
    .trade-panel .value.green,.trade-panel .value.percent.green{color:var(--text-green);font-size:18px;font-weight:700}
    .trade-panel .value.red,.trade-panel .value.percent.red{color:var(--text-red);font-size:18px;font-weight:700}
    .trade-panel .margin-ratio-value{font-size:12px!important}

    .trade-panel .tp-actions{display:flex;justify-content:space-between;gap:8px;margin-top:2px}
    .trade-panel .tp-btn{flex:1;background:var(--btn-bg);color:#fff;border:none;border-radius:6px;padding:6px 0;font-size:12px;cursor:pointer;transition:background .3s}
    .trade-panel .tp-btn:hover{background:var(--secondary-bg)}

    .bottom-nav{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:var(--app-w);background:#2A2F3A;display:flex;padding:8px 0}
    .bottom-nav button{flex:1;display:flex;flex-direction:column;align-items:center;font-size:10px;color:#A1A6B0}
    .bottom-nav button.active{color:#FFF}
    .bottom-nav i{margin-bottom:4px;font-size:16px}
  </style>
</head>
<body>
  <div class="app">
    <!-- Segmented control -->
    <header class="top-toggle" aria-label="Exchange or Wallet">
      <span class="seg-thumb" aria-hidden="true"></span>
      <button class="toggle-btn active" type="button">Exchange</button>
      <button class="toggle-btn" type="button">Wallet</button>
    </header>

    <nav class="main-nav" aria-label="Main sections">
      <button>Overview</button>
      <button class="active">Futures</button>
      <button>Spot</button>
      <button>Funding</button>
    </nav>

    <div class="sub-toggle" role="tablist" aria-label="Futures type">
      <button class="toggle-btn active" role="tab" aria-selected="true">USDⓢ-M</button>
      <button class="toggle-btn" role="tab" aria-selected="false">COIN-M</button>
    </div>

    <section class="balance-panel" aria-label="Balances">
      <div class="balance-header">
        <span>Margin Balance <i id="eyeToggle" class="fas fa-eye" aria-hidden="true"></i></span>
        <span class="icon-group" aria-label="Actions">
          <i class="fas fa-gift" title="Rewards"></i>
          <i class="fas fa-right-left" title="Convert"></i>
          <i class="fas fa-file-invoice" title="Statements"></i>
        </span>
      </div>

      <div class="balance-amount">
        <span id="amount" class="amount">Loading…</span>
        <span class="currency">USD <i class="fas fa-chevron-down" aria-hidden="true"></i></span>
      </div>

      <div class="realized-pnl" id="pnl">
        Today’s Realized PNL
        <span id="realizedSpan" class="gain">Loading…</span>
        <i class="fas fa-chevron-right" aria-hidden="true"></i>
      </div>

      <div class="small-balances">
        <div class="small-item">
          <div class="label">Wallet Balance (USD)</div>
          <div class="value" id="walletValue">Loading…</div>
        </div>
        <div class="small-item">
          <div class="label">Unrealized PNL (USD)</div>
          <div class="value" id="unrealizedValue">Loading…</div>
        </div>
      </div>
    </section>

    <section class="actions" aria-label="Quick actions">
      <button class="btn primary active">Trade</button>
      <button class="btn">Swap</button>
      <button class="btn">Transfer</button>
    </section>

    <section class="positions" aria-label="Positions">
      <nav class="sub-nav-2">
        <button class="active">Positions</button>
        <button>Assets</button>
      </nav>
      <div class="feed" id="feed">
        <div class="empty-state" id="emptyState">
          <i class="fa-solid fa-briefcase"></i>
          <h4>You have no open positions</h4>
          <p>Start a trade to see it listed here in real-time.</p>
          <button class="cta"><i class="fa-solid fa-plus"></i> Open a Trade</button>
        </div>
      </div>
    </section>

    <nav class="bottom-nav" aria-label="Bottom navigation">
      <button><i class="fas fa-home"></i><span>Home</span></button>
      <button><i class="fas fa-chart-bar"></i><span>Markets</span></button>
      <button><i class="fas fa-exchange-alt"></i><span>Trade</span></button>
      <button><i class="fas fa-chart-line"></i><span>Futures</span></button>
      <button class="active"><i class="fas fa-wallet"></i><span>Assets</span></button>
    </nav>
  </div>

  <script>
    // ===== Segmented control thumb =====
    (function(){
      const wrap = document.querySelector('.app .top-toggle');
      const btns  = [...wrap.querySelectorAll('.toggle-btn')];
      const thumb = wrap.querySelector('.seg-thumb');
      const setActive = (i) => {
        btns.forEach((b,idx)=> b.classList.toggle('active', idx===i));
        thumb.style.transform = `translateX(${i*100}%)`;
      };
      setActive(0);
      btns.forEach((b,i)=> b.addEventListener('click',()=>setActive(i)));
    })();

    // ---------- Utilities ----------
    const fmtMoney = (n) =>
      "$" + Number(n).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    // generic money with custom decimals (used for per-symbol PnL decimals)
    const fmtMoneyWith = (n, dec) =>
      "$" + Number(n).toLocaleString(undefined, { minimumFractionDigits: dec, maximumFractionDigits: dec });

    const fmtPct = (n) => (n >= 0 ? "+" : "") + n.toFixed(2) + "%";

    // Default price precisions (will be overwritten by FUTURES exchangeInfo tick sizes)
    const symbolPrecisions = {
      BTCUSDT:2, ETHUSDT:2, BNBUSDT:2, ADAUSDT:4, SOLUSDT:3, XRPUSDT:4, DOTUSDT:3, LTCUSDT:2,
      LINKUSDT:3, DOGEUSDT:5, UNIUSDT:3, BCHUSDT:2, XLMUSDT:5, ATOMUSDT:3, MATICUSDT:4, AVAXUSDT:3,
      TRXUSDT:5, EOSUSDT:3, NEARUSDT:3, FILUSDT:3, OPUSDT:3, ARBUSDT:3, SUIUSDT:4, APTUSDT:3,
      FTMUSDT:4, ICPUSDT:3, SHIBUSDT:8, PEPEUSDT:8, SEIUSDT:4, INJUSDT:3
    };

    // Profit decimal places per symbol (initially mirror price decimals; updated via exchangeInfo)
    const profitPrecisions = { ...symbolPrecisions };

    const maintRate = {
      BTCUSDT:0.004, ETHUSDT:0.005, BNBUSDT:0.005, ADAUSDT:0.010, SOLUSDT:0.008, XRPUSDT:0.010, DOTUSDT:0.010,
      LTCUSDT:0.010, LINKUSDT:0.010, DOGEUSDT:0.012, UNIUSDT:0.010, BCHUSDT:0.010, XLMUSDT:0.015, ATOMUSDT:0.010,
      MATICUSDT:0.010, AVAXUSDT:0.010, TRXUSDT:0.020, EOSUSDT:0.015, NEARUSDT:0.020, FILUSDT:0.015,
      OPUSDT:0.015, ARBUSDT:0.015, SUIUSDT:0.015, APTUSDT:0.015, FTMUSDT:0.020, ICPUSDT:0.015, SHIBUSDT:0.025,
      PEPEUSDT:0.030, SEIUSDT:0.020, INJUSDT:0.015
    };

    const getP = (sym) => symbolPrecisions[sym] ?? 2;
    const getPP = (sym) => profitPrecisions[sym] ?? getP(sym); // profit precision (per symbol)

    // format number with symbol's price precision
    const fSym = (sym, x) => {
      const p = getP(sym);
      const s = Number(x).toFixed(p);
      const [i, d] = s.split(".");
      const intFmt = i.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      return (d !== undefined) ? `${intFmt}.${d}` : intFmt;
    };

    // format **mark price** to match **profit** decimals for that symbol (as requested)
    const fProfitSym = (sym, x) => {
      const p = getPP(sym);
      const s = Number(x).toFixed(p);
      const [i, d] = s.split(".");
      const intFmt = i.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      return (d !== undefined) ? `${intFmt}.${d}` : intFmt;
    };

    // ---------- Top panel refs ----------
    const amountEl = document.getElementById("amount");
    const walletEl = document.getElementById("walletValue");
    const unrealEl = document.getElementById("unrealizedValue");
    const pnlEl = document.getElementById("pnl");
    const eye = document.getElementById("eyeToggle");
    const realizedSpan = document.getElementById("realizedSpan");

    // Hard rules
    const BAL_MIN = 65000, BAL_MAX = 125000;               // margin balance range
    const REALIZED_MIN_PCT = 0.50, REALIZED_MAX_PCT = 2.00; // 0.5%–2%

    // Runtime state
    let show = true;
    let marginBalanceTarget = 0; // chosen in range
    let realizedTodayUSD = 0;
    let realizedTodayPct = 0;
    let walletBalance = 0;
    let unrealizedSum = 0;

    // ---------- Trades / positions ----------
    const feedDiv = document.getElementById("feed");
    const TRADES = 24;
    const trades = [];

    const makeBars = () => {
      let html = "";
      const totalBars = 4;
      const greenBars = Math.floor(Math.random() * totalBars) + 1;
      for (let j = 0; j < totalBars; j++) html += `<span class="${j < greenBars ? 'green' : ''}"></span>`;
      return html;
    };

    function makePanel(sym, lev, margin, entry, mark, qty, mmr) {
      const panel = document.createElement("div");
      panel.className = "trade-panel";
      panel.innerHTML = `
        <div class="header">
          <span class="icon-buy">B</span>
          <span class="symbol">${sym}</span>
          <span class="tag">PERP</span>
          <span class="tag">Cross ${lev}×</span>
          <span class="exclamations">${makeBars()}</span>
          <i class="fas fa-share-nodes share"></i>
        </div>

        <div class="content-columns">
          <div class="column">
            <div class="stat">
              <div class="label">PNL (USDT)</div>
              <div class="value green" data-role="pnl">$0.00</div>
            </div>
            <div class="stat">
              <div class="label">Size (USDT)</div>
              <div class="value" data-role="size">$0.00</div>
            </div>
            <div class="stat">
              <div class="label">Entry Price (USDT)</div>
              <div class="value" data-role="entry">${fSym(sym, entry)}</div>
            </div>
          </div>

          <div class="column center">
            <div class="stat">
              <div class="label no-line">Margin (USDT)</div>
              <div class="value" data-role="margin">${fmtMoney(margin)}</div>
            </div>
            <div class="stat">
              <div class="label no-line">Mark Price (USDT)</div>
              <div class="value" data-role="mark">${fProfitSym(sym, mark)}</div>
            </div>
          </div>

          <div class="column right">
            <div class="stat">
              <div class="label">ROI</div>
              <div class="value percent green" data-role="roi">+0.00%</div>
            </div>
            <div class="stat margin-ratio">
              <div class="label">Margin Ratio</div>
              <div class="value percent margin-ratio-value green" data-role="mratio">0.00%</div>
            </div>
            <div class="stat">
              <div class="label no-line">Liq. Price (USDT)</div>
              <div class="value" data-role="liq">${fSym(sym, entry * (1 - 1/lev + mmr))}</div>
            </div>
          </div>
        </div>

        <div class="tp-actions">
          <button class="tp-btn">Leverage</button>
          <button class="tp-btn">TP/SL</button>
          <button class="tp-btn">Close</button>
          <button class="tp-btn">Reverse</button>
        </div>
      `;
      feedDiv.appendChild(panel);
      return { el: panel, sym, lev, margin, entry, mark, qty, mmr };
    }

    function recalcTrade(t) {
      // USDT-M Long PnL
      const pnl = (t.mark - t.entry) * t.qty;
      const roi = (pnl / t.margin) * 100;

      const sizeUSDT = Math.abs(t.qty * t.mark);
      const notional = Math.abs(t.qty * t.entry);
      const maintenance = notional * t.mmr;
      const equity = t.margin + pnl;
      const mratio = Math.max(0, (maintenance / Math.max(0.01, equity)) * 100);

      const e = (sel) => t.el.querySelector(sel);

      // === KEY CHANGE: PnL uses per-symbol profit decimals; Mark Price matches profit decimals ===
      e('[data-role="pnl"]').textContent = fmtMoneyWith(pnl, getPP(t.sym));
      e('[data-role="pnl"]').classList.toggle('green', pnl >= 0);
      e('[data-role="pnl"]').classList.toggle('red', pnl < 0);

      e('[data-role="roi"]').textContent = fmtPct(roi);
      e('[data-role="roi"]').classList.toggle('green', roi >= 0);
      e('[data-role="roi"]').classList.toggle('red', roi < 0);

      e('[data-role="size"]').textContent = fmtMoney(sizeUSDT); // size in USDT (keep 2dp for fiat)
      e('[data-role="mark"]').textContent = fProfitSym(t.sym, t.mark);

      e('[data-role="mratio"]').textContent = mratio.toFixed(2) + "%";
      e('[data-role="mratio"]').classList.toggle('green', mratio < 80);
      e('[data-role="mratio"]').classList.toggle('red', mratio >= 80);

      e('[data-role="liq"]').textContent = fSym(t.sym, t.entry * (1 - 1/t.lev + t.mmr));

      return pnl;
    }

    function refreshTop() {
      amountEl.textContent   = show ? fmtMoney(walletBalance + unrealizedSum) : "•••••••";
      walletEl.textContent   = show ? fmtMoney(walletBalance) : "•••••••";
      // Top-line Unrealized PNL kept with 2dp (overall account figure)
      unrealEl.textContent   = show ? fmtMoney(unrealizedSum) : "•••••••";
      realizedSpan.textContent = show ? `${fmtMoney(realizedTodayUSD)} (${fmtPct(realizedTodayPct)})` : "•••••••";
    }

    eye.addEventListener("click", () => {
      show = !show;
      eye.classList.toggle("fa-eye-slash", !show);
      eye.classList.toggle("fa-eye", show);
      refreshTop();
    });

    async function fetchJSON(url, fallback) {
      try {
        const r = await fetch(url);
        if (!r.ok) throw new Error("HTTP "+r.status);
        return await r.json();
      } catch {
        return fallback;
      }
    }

    function uniq(arr){ return [...new Set(arr)]; }

    // ---- Binance WS (Futures mark price) ----
    let wsList = [];
    function openMarkPriceWS(symbols) {
      closeMarkPriceWS();

      const chunks = [];
      const lower = symbols.map(s => s.toLowerCase());
      // chunk streams to avoid very long URLs (safety)
      while (lower.length) chunks.push(lower.splice(0, 30));

      chunks.forEach(chunk => {
        const streams = chunk.map(s => `${s}@markPrice@1s`).join('/');
        const url = `wss://fstream.binance.com/stream?streams=${streams}`;
        const ws = new WebSocket(url);

        ws.onmessage = (ev) => {
          try{
            const msg = JSON.parse(ev.data);
            const data = msg.data || msg; // combined stream has {stream,data}
            const sym = (data.s || "").toUpperCase();
            const mark = parseFloat(data.p); // mark price
            if (!sym || !isFinite(mark)) return;

            let changed = false;
            for (const t of trades) {
              if (t.sym === sym) {
                t.mark = mark;
                changed = true;
                recalcTrade(t);
              }
            }
            if (changed) {
              // recompute total unrealized just-in-time
              let sum = 0;
              for (const t of trades) sum += (t.mark - t.entry) * t.qty;
              unrealizedSum = sum;
              refreshTop();
            }
          }catch(e){/* noop */}
        };
        ws.onerror = () => {/* allow fallback poll to kick in if closed */};
        ws.onclose  = () => {/* noop; fallback timer handles gaps */};
        wsList.push(ws);
      });
    }
    function closeMarkPriceWS(){
      wsList.forEach(w => { try{ w.close(); }catch{} });
      wsList = [];
    }

    // ---- Fallback polling (1s) if WS not connected ----
    let pollTimer = null;
    function startFallbackPolling(symbols){
      if (pollTimer) clearInterval(pollTimer);
      pollTimer = setInterval(async () => {
        try{
          const url = `https://fapi.binance.com/fapi/v1/premiumIndex?symbol=`;
          // poll each to stay close to real-time; still light because we cap symbols
          for (const s of symbols) {
            const j = await fetchJSON(url + encodeURIComponent(s), null);
            const mark = j ? parseFloat(j.markPrice) : NaN;
            if (!isFinite(mark)) continue;
            for (const t of trades) {
              if (t.sym === s) {
                t.mark = mark;
                recalcTrade(t);
              }
            }
          }
          let sum = 0;
          for (const t of trades) sum += (t.mark - t.entry) * t.qty;
          unrealizedSum = sum;
          refreshTop();
        }catch(e){/* ignore */ }
      }, 1000);
    }

    // Detect WS health; if all sockets die, use fallback; when page hides, close WS
    window.addEventListener('beforeunload', closeMarkPriceWS);

    // ---------- Init ----------
    async function initTrades() {
      // 1) Pick a Margin Balance target in your required range
      marginBalanceTarget = Math.round(((BAL_MIN + Math.random()*(BAL_MAX - BAL_MIN)) + Number.EPSILON) * 100) / 100;

      // 2) Spot prices just to seed entry/mark
      const prices = await fetchJSON(
        "https://api.binance.com/api/v3/ticker/price",
        [ {symbol:"BTCUSDT",price:"65000"}, {symbol:"ETHUSDT",price:"3000"} ]
      );
      const priceMap = Object.fromEntries(prices.map(d => [d.symbol, parseFloat(d.price)]));

      // 3) FUTURES precisions from fapi exchangeInfo (mirror real decimals)
      const baseSyms = Object.keys(symbolPrecisions);
      const wanted = JSON.stringify(baseSyms);
      const ex = await fetchJSON("https://fapi.binance.com/fapi/v1/exchangeInfo?symbols=" + encodeURIComponent(wanted), {symbols:[]});
      if (ex && Array.isArray(ex.symbols)) {
        ex.symbols.forEach(s => {
          const pf = (s.filters || []).find(f => f.filterType === "PRICE_FILTER");
          if (pf && typeof pf.tickSize === "string") {
            const dec = pf.tickSize.includes(".")
              ? pf.tickSize.split(".")[1].replace(/0+$/,"").length
              : 0;
            // Price precision for entry/liq
            symbolPrecisions[s.symbol] = Math.max(dec, 0);
            // === KEY CHANGE: profit decimals per symbol align to Binance tick decimals ===
            profitPrecisions[s.symbol] = Math.max(dec, 0);
          }
        });
      }

      // Clear empty state
      const empty = document.getElementById("emptyState");
      if (empty) empty.remove();

      // 4) Build trades
      const pick = Object.keys(symbolPrecisions);
      const leverages = [10,20,50,100];
      const usedSymbols = [];

      for (let i = 0; i < TRADES; i++) {
        const sym = pick[i % pick.length];
        const live = priceMap[sym];
        if (!live || isNaN(live)) continue;

        const lev = leverages[Math.floor(Math.random() * leverages.length)];
        const margin = Math.random() * (1000 - 50) + 50;

        const entry = live * 0.94;
        const mark  = live * 0.98;

        const qty = (margin * lev) / entry;
        const mmr = maintRate[sym] ?? 0.01;

        const t = makePanel(sym, lev, margin, entry, mark, qty, mmr);
        trades.push(t);
        usedSymbols.push(sym);
      }

      // 5) Compute initial unrealized PNL (exact sum of position pnls)
      unrealizedSum = 0;
      trades.forEach(t => unrealizedSum += recalcTrade(t));

      // 6) Choose wallet so Margin Balance hits target initially
      walletBalance = marginBalanceTarget - unrealizedSum;

      // 7) Realized PNL must be 0.50%–2.00% of marginBalanceTarget
      realizedTodayPct = REALIZED_MIN_PCT + Math.random()*(REALIZED_MAX_PCT - REALIZED_MIN_PCT);
      realizedTodayUSD = marginBalanceTarget * (realizedTodayPct/100);

      refreshTop();

      // 8) Open live WS so mark price speed == Binance push speed
      const uniqSyms = uniq(usedSymbols);
      openMarkPriceWS(uniqSyms);

      // 9) Start fallback polling in case WS is blocked
      startFallbackPolling(uniqSyms);
    }

    // Seed placeholders
    amountEl.textContent = "Loading…";
    walletEl.textContent = "Loading…";
    unrealEl.textContent = "Loading…";
    realizedSpan.textContent = "Loading…";

    initTrades();
  </script>
</body>
</html>
